---
layout: post
title: "内网穿透,socket代理,解析报文"
date: 2019-02-01
categories: Python
tags: [Python]
image: http://gastonsanchez.com/images/blog/mathjax_logo.png?raw=true
---

本文简单介绍Python 内网穿透的实现，附带解析报文包括 http1.0 http1.1协议
Github:https://github.com/daijiangtian/SocketProxy/edit/master/README.md

<!-- more -->

### HTTP代理
代理（英语：Proxy），也称网络代理，是一种特殊的网络服务，允许一个网络终端（一般为客户端）通过这个服务与另一个网络终端（一般为服务器）进行非直接的连接。一些网关、路由器等网络设备具备网络代理功能。一般认为代理服务有利于保障网络终端的隐私或安全，防止攻击。

Socket又称"套接字"，应用程序通常通过"套接字"向网络发出请求或者应答网络请求。
以python socket库为例，Socket是建立网络连接时使用的。在连接成功时，应用程序两端都会产生一个Socket实例，操作这个实例，完成所需的会话。
![](https://images2015.cnblogs.com/blog/938876/201606/938876-20160611152927293-1786781422.png)

```python
self.proxy = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
self.proxy.bind(addr)
self.proxy.listen()
```

使用select库 IO多路复用使单个process就可以同时处理多个网络IO。基本原理是select\epoll会不断的轮询所负责的所有socket，当有某个socket数据到达了，就通知用户进程。

```python
while 1:
    readable, _, _ = select.select(self.inputs, [], [])  # 多路复用
    for sock in readable:
        try :
            if sock == self.proxy:
                self.forward() #创建转发socket 并且将两端socket关联
            else:
                try:
                    data = sock.recv(8096)
                except:
                    continue

                if not data:
                    self.quit(sock) #关闭两端socket 并将其移出监听
                
                else:
                    # 封装数据用于解析
                    temp = self.metadata.get(sock,[])
                    temp.append(data)
                    self.metadata.update({sock:temp})
                
                    # 看是否有连上目标主机 若没有连上尝试链接 若连上则直接
                    try:
                        self.route[sock].getpeername()
                    except:
                        #若有设置正想代理则直接链接正向代理 否则从head中获取目标ip:port
                        if self.to_addr :
                            self.route[sock].connect(self.to_addr)
                        else:
                            headers = Header(str(data, 'utf-8', errors='ignore')).headers
                            res = headers.get('Host').split(':')
                
                            try:
                                ip = socket.gethostbyname(res[0])
                            except:
                                ip = res[0]
                
                            try:
                                port = int(res[1])
                            except:
                                port = 80
                            self.route[sock].connect((ip,port))
                
                        self.route[sock].send(data) 
```

```
b'GET http://wiki.jikexueyuan.com/project/elasticsearch-definitive-guide-cn/030_Data/05_Document.html HTTP/1.1\r\nHost: wiki.jikexueyuan.com\r\nUser-Agent: python-requests/2.18.4\r\nAccept-Encoding: gzip, deflate\r\nAccept: */*\r\nConnection: keep-alive\r\n\r\n'
b'HTTP/1.1 200 OK\r\nServer: nginx/1.7.10\r\nContent-Type: text/html; charset=UTF-8\r\nConnection: close\r\nCache-Control: no-cache\r\nDate: Sun, 26 Aug 2018 12:56:28 GMT\r\nSet-Cookie: laravel_session=eyJpdiI6InlsdkhKTUlZTW9tZElxZURaS0VpbkE9PSIsInZhbHVlIjoiRStKQlRjaE44eURJYmV3MTBMUEJ5bWN6THUrcEd0QVJoOFhcL2xwWEpZU1Zhd0dVWnZLc3dGUTNZQXh3SForYUJvSWs2NFM0M3p3eUhlSWMzank2RmdBPT0iLCJtYWMiOiJmMTE3MTY3OGIyNDYxMTUwNWQ1N2MxODBiNjQ0YmEzODAwZmFlODNhODZjZDUyYzFiNTE2YTY1MTgwZWFkNWI4In0%3D; expires=Sun, 26-Aug-2018 14:56:28 GMT; Max-Age=7200; path=/; httponly\r\nContent-Encoding: gzip\r\nVary: Accept-Encoding\r\nSet-Cookie: QINGCLOUDELB=b2396366bd639e01fbd88e4a829ce868d562b81daa2a899c46d3a1e304c7eb2b|W4Kjf|W4Kjf; path=/; HttpOnly\r\n\r\n'
```

```
b'GET http://www.baidu.com/ HTTP/1.1\r\nHost: www.baidu.com\r\nUser-Agent: python-requests/2.18.4\r\nAccept-Encoding: gzip, deflate\r\nAccept: */*\r\nConnection: keep-alive\r\n\r\n'
b'HTTP/1.1 200 OK\r\nServer: bfe/1.0.8.18\r\nDate: Sun, 26 Aug 2018 13:06:09 GMT\r\nContent-Type: text/html\r\nLast-Modified: Mon, 23 Jan 2017 13:28:11 GMT\r\nTransfer-Encoding: chunked\r\nConnection: Close\r\nCache-Control: private, no-cache, no-store, proxy-revalidate, no-transform\r\nPragma: no-cache\r\nSet-Cookie: BDORZ=27315; max-age=86400; domain=.baidu.com; path=/\r\nContent-Encoding: gzip\r\n\r\n'
```

Chunked 
分块传输编码（Chunked transfer encoding）是只在HTTP协议1.1版本（HTTP/1.1）中提供的一种数据传送机制。以往HTTP的应答中数据是整个一起发送的，并在应答头里Content-Length字段标识了数据的长度，以便客户端知道应答消息的结束。

```python
@property
def body(self):
    # print(self.headers)
    content_type = self.headers.get('Content-Type',None)
    transfer_encoding  = self.headers.get('Transfer-Encoding',None)
    content_encoding = self.headers.get('Content-Encoding',None)

    self.contents[0] = self._body_content()
    for body_content in self.contents:
        try:
            if (body_content):
                if transfer_encoding == 'chunked':
                    body_content = self._chunked_body(body_content)

                if content_encoding:
                    return get_decoder(content_encoding).decompress(body_content)
                return body_content
        except:
            pass


def _get_index(self, content, partten):
    for i in range(len(content)):
        #   print(content[i:i + 4])
        if (content[i:i + len(partten)]) == partten:
            return i + len(partten)
    return 0

def _body_content(self):
    # print(self.content)
    length = self._get_index(self.contents[0], b'\r\n\r\n')
    body_content = self.contents[0][length:]
    return body_content

def _chunked_body(self,content):
    body_content = b''
    while 1:
        try:
          #  print(content)
            index = self._get_index(content, b'\r\n') - 2
            if index <= 0:
                break
            count = int(content[:index].decode('utf-8'), 16)
            if (count == 0):
                break
            body_content = body_content + content[index + 2:count + index + 2]
            content = content[count + index + 2 + 2:]
        except:
            break
    return body_content

```


```json
{'post_data': {'mothed': 'GET', 'path': 'http://www.baidu.com/', 'params': {}, 'headers': {'Host': 'www.baidu.com', 'User-Agent': 'python-requests/2.18.4', 'Accept-Encoding': 'gzip, deflate', 'Accept': '*/*', 'Connection': 'keep-alive'}, 'body': None, 'html': None}, 'get_data': {'mothed': 'HTTP/1.1', 'path': '200', 'params': {}, 'headers': {'Server': 'bfe/1.0.8.18', 'Date': 'Sun, 26 Aug 2018 13:06:09 GMT', 'Content-Type': 'text/html', 'Last-Modified': 'Mon, 23 Jan 2017 13:28:11 GMT', 'Transfer-Encoding': 'chunked', 'Connection': 'Close', 'Cache-Control': 'private, no-cache, no-store, proxy-revalidate, no-transform', 'Pragma': 'no-cache', 'Set-Cookie': 'BDORZ=27315; max-age=86400; domain=.baidu.com; path=/', 'Content-Encoding': 'gzip'}, 'body': b'<!DOCTYPE html>\r\n<!--STATUS OK--><html> <head><meta http-equiv=content-type content=text/html;charset=utf-8><meta http-equiv=X-UA-Compatible content=IE=Edge><meta content=always name=referrer><link rel=stylesheet type=text/css href=http://s1.bdstatic.com/r/www/cache/bdorz/baidu.min.css><title>\xe7\x99\xbe\xe5\xba\xa6\xe4\xb8\x80\xe4\xb8\x8b\xef\xbc\x8c\xe4\xbd\xa0\xe5\xb0\xb1\xe7\x9f\xa5\xe9\x81\x93</title></head> <body link=#0000cc> <div id=wrapper> <div id=head> <div class=head_wrapper> <div class=s_form> <div class=s_form_wrapper> <div id=lg> <img hidefocus=true src=//www.baidu.com/img/bd_logo1.png width=270 height=129> </div> <form id=form name=f action=//www.baidu.com/s class=fm> <input type=hidden name=bdorz_come value=1> <input type=hidden name=ie value=utf-8> <input type=hidden name=f value=8> <input type=hidden name=rsv_bp value=1> <input type=hidden name=rsv_idx value=1> <input type=hidden name=tn value=baidu><span class="bg s_ipt_wr"><input id=kw name=wd class=s_ipt value maxlength=255 autocomplete=off autofocus></span><span class="bg s_btn_wr"><input type=submit id=su value=\xe7\x99\xbe\xe5\xba\xa6\xe4\xb8\x80\xe4\xb8\x8b class="bg s_btn"></span> </form> </div> </div> <div id=u1> <a href=http://news.baidu.com name=tj_trnews class=mnav>\xe6\x96\xb0\xe9\x97\xbb</a> <a href=http://www.hao123.com name=tj_trhao123 class=mnav>hao123</a> <a href=http://map.baidu.com name=tj_trmap class=mnav>\xe5\x9c\xb0\xe5\x9b\xbe</a> <a href=http://v.baidu.com name=tj_trvideo class=mnav>\xe8\xa7\x86\xe9\xa2\x91</a> <a href=http://tieba.baidu.com name=tj_trtieba class=mnav>\xe8\xb4\xb4\xe5\x90\xa7</a> <noscript> <a href=http://www.baidu.com/bdorz/login.gif?login&amp;tpl=mn&amp;u=http%3A%2F%2Fwww.baidu.com%2f%3fbdorz_come%3d1 name=tj_login class=lb>\xe7\x99\xbb\xe5\xbd\x95</a> </noscript> <script>document.write(\'<a href="http://www.baidu.com/bdorz/login.gif?login&tpl=mn&u=\'+ encodeURIComponent(window.location.href+ (window.location.search === "" ? "?" : "&")+ "bdorz_come=1")+ \'" name="tj_login" class="lb">\xe7\x99\xbb\xe5\xbd\x95</a>\');</script> <a href=//www.baidu.com/more/ name=tj_briicon class=bri style="display: block;">\xe6\x9b\xb4\xe5\xa4\x9a\xe4\xba\xa7\xe5\x93\x81</a> </div> </div> </div> <div id=ftCon> <div id=ftConw> <p id=lh> <a href=http://home.baidu.com>\xe5\x85\xb3\xe4\xba\x8e\xe7\x99\xbe\xe5\xba\xa6</a> <a href=http://ir.baidu.com>About Baidu</a> </p> <p id=cp>&copy;2017&nbsp;Baidu&nbsp;<a href=http://www.baidu.com/duty/>\xe4\xbd\xbf\xe7\x94\xa8\xe7\x99\xbe\xe5\xba\xa6\xe5\x89\x8d\xe5\xbf\x85\xe8\xaf\xbb</a>&nbsp; <a href=http://jianyi.baidu.com/ class=cp-feedback>\xe6\x84\x8f\xe8\xa7\x81\xe5\x8f\x8d\xe9\xa6\x88</a>&nbsp;\xe4\xba\xacICP\xe8\xaf\x81030173\xe5\x8f\xb7&nbsp; <img src=//www.baidu.com/img/gs.gif> </p> </div> </div> </div> </body> </html>\r\n', 'html': '<!DOCTYPE html>\r\n<!--STATUS OK--><html> <head><meta http-equiv=content-type content=text/html;charset=utf-8><meta http-equiv=X-UA-Compatible content=IE=Edge><meta content=always name=referrer><link rel=stylesheet type=text/css href=http://s1.bdstatic.com/r/www/cache/bdorz/baidu.min.css><title>百度一下，你就知道</title></head> <body link=#0000cc> <div id=wrapper> <div id=head> <div class=head_wrapper> <div class=s_form> <div class=s_form_wrapper> <div id=lg> <img hidefocus=true src=//www.baidu.com/img/bd_logo1.png width=270 height=129> </div> <form id=form name=f action=//www.baidu.com/s class=fm> <input type=hidden name=bdorz_come value=1> <input type=hidden name=ie value=utf-8> <input type=hidden name=f value=8> <input type=hidden name=rsv_bp value=1> <input type=hidden name=rsv_idx value=1> <input type=hidden name=tn value=baidu><span class="bg s_ipt_wr"><input id=kw name=wd class=s_ipt value maxlength=255 autocomplete=off autofocus></span><span class="bg s_btn_wr"><input type=submit id=su value=百度一下 class="bg s_btn"></span> </form> </div> </div> <div id=u1> <a href=http://news.baidu.com name=tj_trnews class=mnav>新闻</a> <a href=http://www.hao123.com name=tj_trhao123 class=mnav>hao123</a> <a href=http://map.baidu.com name=tj_trmap class=mnav>地图</a> <a href=http://v.baidu.com name=tj_trvideo class=mnav>视频</a> <a href=http://tieba.baidu.com name=tj_trtieba class=mnav>贴吧</a> <noscript> <a href=http://www.baidu.com/bdorz/login.gif?login&amp;tpl=mn&amp;u=http%3A%2F%2Fwww.baidu.com%2f%3fbdorz_come%3d1 name=tj_login class=lb>登录</a> </noscript> <script>document.write(\'<a href="http://www.baidu.com/bdorz/login.gif?login&tpl=mn&u=\'+ encodeURIComponent(window.location.href+ (window.location.search === "" ? "?" : "&")+ "bdorz_come=1")+ \'" name="tj_login" class="lb">登录</a>\');</script> <a href=//www.baidu.com/more/ name=tj_briicon class=bri style="display: block;">更多产品</a> </div> </div> </div> <div id=ftCon> <div id=ftConw> <p id=lh> <a href=http://home.baidu.com>关于百度</a> <a href=http://ir.baidu.com>About Baidu</a> </p> <p id=cp>&copy;2017&nbsp;Baidu&nbsp;<a href=http://www.baidu.com/duty/>使用百度前必读</a>&nbsp; <a href=http://jianyi.baidu.com/ class=cp-feedback>意见反馈</a>&nbsp;京ICP证030173号&nbsp; <img src=//www.baidu.com/img/gs.gif> </p> </div> </div> </div> </body> </html>\r\n'}}
```