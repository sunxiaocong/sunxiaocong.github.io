---
layout: post
title: "Rsyslog "
date: 2019-02-16
categories: 大数据
tags: [大数据, 数据采集,sdk]
image: http://gastonsanchez.com/images/blog/mathjax_logo.png
---


ryslog 是一个快速处理收集系统日志的程序，提供了高性能、安全功能和模块化设计。rsyslog 是syslog 的升级版，它将多种来源输入输出转换结果到目的地，据官网介绍，现在可以处理100万条信息。

<!-- more -->

<img class="centered" src="https://images2015.cnblogs.com/blog/790056/201605/790056-20160505200957685-755096970.png" />

### What's Rsyslog?

Rsyslog is a rocket-fast system for log processing. It offers high-performance, great security features and a modular design. While it started as a regular syslogd, rsyslog has evolved into a kind of swiss army knife of logging, being able to

accept inputs from a wide variety of sources,
transform them,
and output the results to diverse destinations.
Rsyslog has a strong enterprise focus but also scales down to small systems. It supports, among others, MySQL , PostgreSQL, failover log destinations, syslog/tcp transport, fine grain output format control, high precision timestamps, queued operations and the ability to filter on any message part.


### How to config 

* global 全局配置
  * parser.escapeControlCharactersOnReceive
    * rsyslog默认会将特殊字符（\t）转换成#009 由全局配置$EscapeControlCharactersOnReceive 决定，如果自己需要根据\t处理输出时，需将该选项改为off。
  * maxMessageSize
    * 发往es采用批处理　限制单批大小
  * oversizemsg.errorfile
    * 单批大小超过限制　存文件
  * oversizemsg.input.mode
    * 输出模板
  * debug.onShutdown
    * 调试
  * debug.logFile
    * 调试日志文件设置

  ```
  global (
      parser.escapeControlCharactersOnReceive="off"
      maxMessageSize="10m"
      oversizemsg.errorfile="/data/run/oversize.log"
      oversizemsg.input.mode="split"
      debug.onShutdown="on"
      debug.logFile="/data/run/rsyslog_debug.log"
  )
  ```

* timezone

  ```
  timezone(id="UTC" offset="+08:00")
  ```

* module 模块加载
  * module(load="imptcp")
    * 提供通过简单TCP系统日志接收系统日志消息的能力。这是一个专门为Linux高性能量身定制的输入插件。它可能不会运行在任何其他平台上。此外，它不提供TLS服务。加密可以通过使用StnEnter来提供。
  * module(load="builtin:omfile")
    * omfile插件提供了将消息写入驻留在本地文件系统内的文件的核心功能（如果使用NFS之类的方法，实际上可能是远程的）。该模块支持以静态名称命名的文件以及基于消息内容的具有名称的文件。
  * module(load="mmjsonparse")
    * 可以解析json
  * module(load="omelasticsearch")
    * 该模块为日志记录提供原生支持转发es集群。
  * module(load="impstats" interval="20" facility="5" severity="6" log.syslog="on" format="json" resetCounters="on")
    * 提供内部计数器的定期统计信息

  ```
  module(load="imptcp")
  module(load="builtin:omfile")
  module(load="mmjsonparse")
  module(load="omelasticsearch")
  module(load="impstats" interval="20" facility="5" severity="6" log.syslog="on" format="json" resetCounters="on")
  ```

* input

  * input(type="imptcp" port="514")
  * 设置开放端口与协议类型

  ```
  input(type="imptcp" port="514")
  ```

  

* template 　

  * 模板是 rsyslog 一个重要的属性，它可以控制日志的格式，支持类似`template()`语句的基于string或plugin的模板

  * 基本结构

    ```
    template(parameters) 
    ```

  * 列表模板等扩展用法

    ```
    template(parameters) { list-descriptions }
    ```

  * 使用

    * 每个模板都有一个参数**名称**和一个参数**类型**，参数**名称**指定模板名称，参数**类型**指定模板类型。name参数必须是唯一的，如果不是，则行为是不可预测的。该**类型**参数指定不同的模板类型。不同类型只是使用不同的方式来指定模板内容。模板类型**不会**影响（输出）插件可以用它做什么。因此，请使用最适合您需求的类型（从配置文字的角度来看！）。可以使用以下类型：
    * list,subtree,string,plugin
    * constant
      * 用于一些直接使用的文本
      * value - the constant value to use
      * outname - output field name (for structured outputs)
      * format - can be either empty or jsonf
    * property
      *  此语句用于包含属性文本。它可以访问所有属性。此外，选项允许指定只选择一部分属性或修改它。它支持以下参数：
      * **name** - the name of the property to access
      * **outname** - output field name (for structured outputs)
      * **dateformat** - Date format to use (only for date-related properties). [Here](https://www.rsyslog.com/doc/v8-stable/configuration/property_replacer.html#property-options) you can find a list of all property options.
      * **date.inUTC** - date shall be shown in UTC (please note that this requires a bit more performance due to the necessary conversions) Available since 8.18.0.
      * **caseconversion** - permits to convert case of the text. Supported values are “lower” and “upper”
      * **controlcharacters** - specifies how to handle control characters. Supported values are “escape”, which escapes them, “space”, which replaces them by a single space, and “drop”, which simply removes them from the string.
      * **securepath** - used for creating pathnames suitable for use in dynafile templates
      * format
        - specify format on a field basis. Supported values are:
      * **position.from** - obtain substring starting from this position (1 is the first position)
      * **position.to** - obtain substring up to this position
      * **position.relativeToEnd** - the from and to position is relative to the end of the string instead of the usual start of string. (available since rsyslog v7.3.10)
      * **fixedwidth** - changes behaviour of position.to so that it pads the source string with spaces up to the value of position.to if the source string is shorter. “on” or “off” (default) (available since rsyslog v8.13.0)
      * **compressspace** - compresses multiple spaces (US-ASCII SP character) inside the string to a single one. This compression happens at a very late stage in processing. Most importantly, it happens after substring extraction, so the **position.from** and **position.to** positions are **NOT** affected by this option. (available since v8.18.0).
      * **field.number** - obtain this field match
      * **field.delimiter** - decimal value of delimiter character for field extraction
      * **regex.expression** - expression to use
      * **regex.type** - either ERE or BRE
      * **regex.nomatchmode** - what to do if we have no match
      * **regex.match** - match to use
      * **regex.submatch** - submatch to use
      * **droplastlf** - drop a trailing LF, if it is present
      * **mandatory** - signifies a field as mandatory. If set to “on”, this field will always be present in data passed to structured outputs, even if it is empty. If “off” (the default) empty fields will not be passed to structured outputs. This is especially useful for outputs that support dynamic schemas (like ommongodb).
      * **spifno1stsp** - expert options for RFC3164 template processing
